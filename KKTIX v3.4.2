// ==UserScript==
// @name         Kenny KKTIX v3.4.2ï¼ˆè‡ªå‹•æŠ“ç¥¨åƒ¹ + å¼·åŒ–é¸ç¥¨ + è‡ªå‹•åœæ­¢ï¼‰
// @namespace    https://tampermonkey.net/
// @version      3.4.2
// @description  è‡ªå‹•æŠ“ç¥¨åƒ¹ã€æ’é™¤èº«éšœç¥¨ã€æ‹–æ›³GUIã€è¨˜æ†¶è¨­å®šã€æ’ç¨‹æ¶ç¥¨ã€è‡ªå‹•é¸ç¥¨ã€è‡ªå‹•é…ä½ã€è‡ªå‹•ä¸‹ä¸€æ­¥ã€è‡ªå‹•é—œé–‰ popupã€ç„¡ç¥¨è‡ªå‹•ç¢ºèªã€æ¶åˆ°åœæ­¢ã€éˆ´è²é€šçŸ¥
// @match        https://kktix.com/events/*/registrations/new*
// @run-at       document-idle
// @grant        none
// ==/UserScript==

(function () {
    "use strict";

    let running = false;
    let autoStop = false;
    const alarm = new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg");
    const $ = id => document.getElementById(id);

    // === Toast ===
    function toast(msg) {
        const d = document.createElement("div");
        d.innerText = msg;
        d.style.cssText = `
            position: fixed; top: 14%; right: 20px; z-index: 99999;
            background: rgba(0,0,0,.85); color: #fff; padding: 10px 16px;
            border-radius: 8px; font-size: 16px;
        `;
        document.body.appendChild(d);
        setTimeout(() => (d.style.opacity = "0"), 900);
        setTimeout(() => d.remove(), 1300);
    }

    // === è‡ªå‹•è™•ç†ç„¡ç¥¨ popup ===
    function autoHandleSoldOut() {
        const keywords = ["å·²ç„¡ç¥¨", "å·²å”®å®Œ", "æ²’æœ‰ç¥¨", "å”®å®Œ"];
        const obs = new MutationObserver(muts => {
            muts.forEach(m => {
                m.addedNodes.forEach(n => {
                    if (n.nodeType !== 1) return;
                    const txt = n.innerText || "";
                    if (!keywords.some(k => txt.includes(k))) return;
                    const btn = [...n.querySelectorAll("button,input")].find(b =>
                        /ç¢ºå®š|OK|ç¢ºèª/.test(b.innerText || b.value || "")
                    );
                    btn?.click();
                    toast("âš  è‡ªå‹•é—œé–‰ç„¡ç¥¨æç¤º");
                });
            });
        });
        obs.observe(document.body, { childList: true, subtree: true });
    }
    autoHandleSoldOut();

    // === GUI ===
    const gui = document.createElement("div");
    gui.innerHTML = `
        <div id="kenny-box" style="
            background:#111;color:#eee;padding:12px;position:fixed;
            top:20%;right:20px;z-index:9999;width:260px;border-radius:10px;
            border:1px solid #666;font-size:14px;
        ">
            <h3 style="margin-top:0;text-align:center;font-size:18px;cursor:move;">ğŸ« Kenny KKTIX v3.4.1</h3>

            <div id="kenny-content">
                <label>ä¸»ç¥¨åƒ¹ï¼ˆè‡ªå‹•æŠ“åƒ¹ï¼‰</label>
                <input id="p1" type="text" placeholder="è‡ªå‹•åµæ¸¬" style="width:100%;margin-bottom:6px">

                <label>å‚™æ´ç¥¨åƒ¹ï¼ˆç©º=ä»»æ„ï¼‰</label>
                <input id="p2" type="text" placeholder="å¯å¡«å¯ä¸å¡«" style="width:100%;margin-bottom:6px">

                <label>å¼µæ•¸</label>
                <select id="num" style="width:100%;margin-bottom:6px">
                    <option>1</option><option selected>2</option>
                    <option>3</option><option>4</option><option>5</option>
                </select>

                <label>æ¨¡å¼</label>
                <select id="mode" style="width:100%;margin-bottom:6px">
                    <option value="top">ç”±ä¸Šè€Œä¸‹</option>
                    <option value="bottom">ç”±ä¸‹è€Œä¸Š</option>
                    <option value="random" selected>éš¨æ©Ÿ</option>
                </select>

                <label>æœƒå“¡ç·¨è™Ÿ</label>
                <input id="member" type="text" placeholder="å¯ç•™ç©º" style="width:100%;margin-bottom:6px">

                <label>å•Ÿå‹•æ™‚é–“ï¼ˆç©º=ç«‹å³ï¼‰</label>
                <input id="startTime" type="text" placeholder="HH:MM:SS" style="width:100%;margin-bottom:10px">

                <button id="start" style="width:100%;padding:6px;background:#06f;color:white;font-size:16px;border-radius:6px;margin-bottom:6px;">â–¶ å•Ÿå‹•</button>
                <button id="pause" style="width:100%;padding:6px;background:#c00;color:white;font-size:16px;border-radius:6px;">â¸ æš«åœ</button>
            </div>

            <button id="minBtn" style="width:100%;margin-top:6px;padding:4px;background:#444;color:#fff;border-radius:6px;">ğŸ”½ æœ€å°åŒ–</button>
        </div>
    `;
    document.body.appendChild(gui);

    // === è¨˜æ†¶è¨­å®š ===
    ["p1", "p2", "num", "mode", "member", "startTime"].forEach(id => {
        const v = localStorage.getItem("kenny_" + id);
        if (v) $(id).value = v;
    });

    // === GUIç¸®æ”¾ ===
    $("minBtn").onclick = () => {
        const c = $("kenny-content");
        const s = c.style.display === "none";
        c.style.display = s ? "block" : "none";
        $("minBtn").innerText = s ? "ğŸ”½ æœ€å°åŒ–" : "ğŸ”¼ å±•é–‹";
    };

    // === æ‹–æ›³ ===
    (function drag() {
        const box = $("kenny-box");
        let dx = 0, dy = 0, dragging = false;
        box.addEventListener("mousedown", e => {
            dragging = true;
            dx = e.clientX - box.offsetLeft;
            dy = e.clientY - box.offsetTop;
        });
        document.addEventListener("mousemove", e => {
            if (!dragging) return;
            box.style.left = e.clientX - dx + "px";
            box.style.top = e.clientY - dy + "px";
            box.style.right = "auto";
        });
        document.addEventListener("mouseup", () => dragging = false);
    })();

    // === è‡ªå‹•æŠ“ç¥¨åƒ¹ï¼ˆv3.4 ä¿®æ­£ï¼‰
    function getPriceFromRow(row) {
        let price =
            row.querySelector(".ticket-price")?.innerText ||
            row.querySelector(".price")?.innerText ||
            [...row.querySelectorAll("span,div")]
                .map(x => x.innerText)
                .find(t => /TWD|NT\$|\$/.test(t)) ||
            "";

        return price.replace(/\s+/g, "").trim();
    }

    // ======== é¸ç¥¨ï¼ˆæ’é™¤èº«å¿ƒéšœç¤™ç¥¨ + ä¸»ç¥¨ä¾æ¨¡å¼ top/bottom/randomï¼‰ ========
    function selectTicket() {
        let plus = [...document.querySelectorAll(".plus")].filter(btn => {
            const row = btn.closest('.display-table-row')?.innerText || "";
            return !/èº«|éšœ|é™ªåŒ|èº«å¿ƒéšœç¤™/.test(row);
        });

        if (!plus.length) return false;

        const p1 = $("p1").value.trim();
        const p2 = $("p2").value.trim();
        const num = parseInt($("num").value);
        const mode = $("mode").value;

        // =====================
        //   ä¸»ç¥¨ï¼ˆä¾æ¨¡å¼ï¼‰
        // =====================
        if (p1) {
            let mainList = plus.filter(btn => {
                const row = btn.closest('.display-table-row')?.innerText || "";
                return row.includes(p1);
            });

            if (mainList.length > 0) {
                // top / bottom / random
                let btn;
                if (mode === "top") btn = mainList[0];
                else if (mode === "bottom") btn = mainList[mainList.length - 1];
                else btn = mainList[Math.floor(Math.random() * mainList.length)];

                for (let i = 0; i < num; i++) btn.click();
                return true;
            }
        }

        // =====================
        //   å‚™æ´ç¥¨ï¼ˆä»»æ„ç¬¬ä¸€å€‹ç¬¦åˆï¼‰
        // =====================
        if (p2) {
            for (const btn of plus) {
                const row = btn.closest('.display-table-row')?.innerText || "";
                if (row.includes(p2)) {
                    for (let i = 0; i < num; i++) btn.click();
                    return true;
                }
            }
        }

        // =====================
        //   æ²’ä¸»ç¥¨ä¹Ÿæ²’å‚™æ´ â†’ ä»»æ„ç¥¨ä¾æ¨¡å¼
        // =====================
        if (!p2) {
            let btn;
            if (mode === "top") btn = plus[0];
            else if (mode === "bottom") btn = plus[plus.length - 1];
            else btn = plus[Math.floor(Math.random() * plus.length)];

            for (let i = 0; i < num; i++) btn.click();
            return true;
        }

        return false;
    }


    // === è‡ªå‹•ä¸‹ä¸€æ­¥ ===
    function clickNext() {
        document.querySelector('input[type="checkbox"]')?.click();

        // æœƒå“¡å¡«å…¥
        const mem = $("member").value.trim();
        const mf = document.querySelector('input.member-code,input[placeholder*="æœƒå“¡"]');
        if (mf && mem) {
            mf.value = mem;
            mf.dispatchEvent(new Event("input", { bubbles: true }));
        }

        const auto = [...document.querySelectorAll("button")].find(b => b.innerText.includes("é…ä½"));
        if (auto) return auto.click();

        const next = [...document.querySelectorAll("button,input")]
            .find(b => (b.innerText || b.value || "").includes("ä¸‹ä¸€æ­¥"));
        next?.click();
    }

    // === åµæ¸¬çµå¸³ï¼ˆå¼·åŒ–ç‰ˆï¼‰ ===
    function detectCheckoutPage() {
        if (!running) return;

        const html = document.body.innerText;
        const keys = [
            "è¨‚å–®æ˜ç´°","è¨‚å–®è³‡è¨Š","è¯çµ¡äººè³‡æ–™","ä»˜æ¬¾æ–¹å¼",
            "æ”¯ä»˜æ–¹å¼","ä¿¡ç”¨å¡","å–ç¥¨æ–¹å¼","ç¥¨åˆ¸è³‡è¨Š",
            "å¯„é€è³‡è¨Š","Step 3","Step 4"
        ];
        if (keys.some(k => html.includes(k))) {
            running = false;
            if (!autoStop) {
                autoStop = true;
                alarm.play();
                toast("ğŸ‰ å·²é€²å…¥çµå¸³é  â€” åœæ­¢æ¶ç¥¨");
            }
        }
    }
    setInterval(detectCheckoutPage, 400);

    // === ä¸»æµç¨‹ ===
    function main() {
        if (!running) return;

        if (selectTicket()) {
            alarm.play();
            setTimeout(clickNext, 200);
        } else {
            setTimeout(() => running && location.reload(), 800);
        }
    }

    // === æ§åˆ¶ ===
    $("start").onclick = () => {
        ["p1", "p2", "num", "mode", "member", "startTime"].forEach(id =>
            localStorage.setItem("kenny_" + id, $(id).value.trim())
        );

        const T = $("startTime").value.trim();
        if (!T) {
            running = true;
            toast("ğŸš€ å·²å•Ÿå‹•æ¶ç¥¨");
            main();
            return;
        }

        toast("â³ å·²è¨­å®šæ’ç¨‹");
        const timer = setInterval(() => {
            if (new Date().toTimeString().slice(0, 8) >= T) {
                clearInterval(timer);
                running = true;
                toast("ğŸ”¥ æ™‚é–“åˆ° â†’ é–‹å§‹æ¶ç¥¨ï¼");
                main();
            }
        }, 200);
    };

    $("pause").onclick = () => {
        running = false;
        toast("â¸ å·²æš«åœ");
    };
})();
