// ==UserScript==
// @name         Kenny KKTIX v3.3ï¼ˆå«æœ€å¤§é‡è©¦ + GUI + æ’ç¨‹æ¶ç¥¨ + è‡ªå‹•é…ä½ + ä¸‹ä¸€æ­¥ + éˆ´è² + è‡ªå‹•æç¤º + ç„¡ç¥¨è‡ªå‹•ç¢ºèª + è‡ªå‹•å›ç­”å•é¡Œï¼‰
// @namespace    https://tampermonkey.net/
// @version      3.3
// @description  GUIæ¶ç¥¨ã€å®šæ™‚å•Ÿå‹•ã€è‡ªå‹•é¸ç¥¨ã€è‡ªå‹•é‡æ•´ã€è‡ªå‹•é…ä½ã€è‡ªå‹•ä¸‹ä¸€æ­¥ã€è‡ªå‹•å¡«æœƒå“¡ã€éˆ´è²é€šçŸ¥ã€è‡ªå‹•æ¶ˆå¤±æç¤ºã€è‡ªå‹•è™•ç†ç„¡ç¥¨è¨Šæ¯ã€è‡ªå‹•å›ç­”å•é¡Œã€æœ€å¤§é‡è©¦æ¬¡æ•¸
// @match        https://kktix.com/events/*/registrations/new*
// @run-at       document-idle
// @grant        none
// ==/UserScript==

(function () {
    'use strict';

    let running = false;
    let retryCount = 0;

    const alarm = new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg");
    const $ = id => document.getElementById(id);

    // ======== è‡ªå‹•æ¶ˆå¤±æç¤º ========
    function toast(msg) {
        const div = document.createElement("div");
        div.innerText = msg;
        div.style.cssText = `
            position: fixed; top: 15%; right: 20px; z-index: 99999;
            background: rgba(0,0,0,0.85); color: #fff; padding: 10px 16px;
            border-radius: 8px; font-size: 16px; box-shadow: 0 0 8px #000;
            transition: opacity .4s;
        `;
        document.body.appendChild(div);
        setTimeout(() => (div.style.opacity = "0"), 900);
        setTimeout(() => div.remove(), 1300);
    }

    // ======== è‡ªå‹•è™•ç†ç„¡ç¥¨è¨Šæ¯ ========
    function autoHandleSoldOut() {
        const soldOutTexts = ["å·²ç„¡ç¥¨", "æ²’æœ‰ç¥¨", "å”®å®Œ", "å”®ç½„", "ç„¡ç¥¨"];
        const observer = new MutationObserver(mutations => {
            mutations.forEach(m => {
                m.addedNodes.forEach(node => {
                    if (node.nodeType !== 1) return;
                    const text = (node.innerText || "").trim();
                    if (!text) return;
                    if (soldOutTexts.some(t => text.includes(t))) {
                        try {
                            const btn = [...node.querySelectorAll("button, input[type=button], input[type=submit]")]
                                .find(b => /ç¢ºå®š|OK|ç¢ºèª|Close|é—œé–‰/.test((b.innerText || b.value || "").trim()));
                            if (btn) {
                                btn.click();
                                toast("âš  ç„¡ç¥¨è¨Šæ¯è‡ªå‹•ç¢ºèª");
                            } else {
                                const modalBtn = [...document.querySelectorAll("button, input[type=button], input[type=submit]")]
                                    .find(b => /ç¢ºå®š|OK|ç¢ºèª|Close|é—œé–‰/.test((b.innerText || b.value || "").trim()));
                                if (modalBtn) {
                                    modalBtn.click();
                                    toast("âš  ç„¡ç¥¨è¨Šæ¯è‡ªå‹•ç¢ºèª (global)");
                                }
                            }
                        } catch (e) {
                            console.warn("autoHandleSoldOut error:", e);
                        }
                    }
                });
            });
        });
        observer.observe(document.body, { childList: true, subtree: true });
    }

    autoHandleSoldOut();

    // ======== GUI å»ºç«‹ ========
    const panel = document.createElement("div");
    panel.innerHTML = `
        <div style="background:#111;color:#eee;padding:12px;position:fixed;top:20%;right:20px;z-index:9999;width:300px;
             font-size:14px;border-radius:10px;border:1px solid #666;">
            <h3 style="margin-top:0;text-align:center;font-size:18px;">ğŸ« Kenny KKTIX</h3>

            <label>ä¸»ç¥¨åƒ¹</label>
            <input id="p1" type="text" placeholder="ä¾‹ï¼šTWD$2,200" style="width:100%;margin-bottom:6px">

            <label>å‚™æ´ç¥¨åƒ¹ï¼ˆç©º=ä»»æ„ï¼‰</label>
            <input id="p2" type="text" placeholder="ä¾‹ï¼šTWD$1,800" style="width:100%;margin-bottom:6px">

            <label>å¼µæ•¸</label>
            <select id="num" style="width:100%;margin-bottom:6px">
                <option>1</option><option selected>2</option><option>3</option><option>4</option><option>5</option>
            </select>

            <label>æ¨¡å¼</label>
            <select id="mode" style="width:100%;margin-bottom:6px">
                <option value="top">ç”±ä¸Šè€Œä¸‹</option>
                <option value="bottom">ç”±ä¸‹è€Œä¸Š</option>
                <option value="random" selected>éš¨æ©Ÿ</option>
            </select>

            <label>æœƒå“¡ç·¨è™Ÿï¼ˆå¯ç•™ç©ºï¼‰</label>
            <input id="member" type="text" placeholder="ä¾‹ï¼šBZ583022889" style="width:100%;margin-bottom:6px">

            <label>å•é¡Œç­”æ¡ˆï¼ˆå¯ç•™ç©ºï¼Œé‡å°æ–‡å­—å•é¡Œï¼‰</label>
            <input id="answer" type="text" placeholder="ä¾‹ï¼š..." style="width:100%;margin-bottom:6px">

            <label>æœ€å¤§é‡è©¦æ¬¡æ•¸</label>
            <input id="maxRetry" type="number" placeholder="ä¾‹ï¼š10" style="width:100%;margin-bottom:6px" min="1">

            <label>å•Ÿå‹•æ™‚é–“ (ç©º=ç«‹å³, HH:MM:SS)</label>
            <input id="startTime" type="text" placeholder="HH:MM:SS" style="width:100%;margin-bottom:10px">

            <button id="start" style="width:100%;padding:6px;margin-bottom:6px;background:#06f;color:white;font-size:16px;border-radius:5px;">â–¶ å•Ÿå‹•</button>
            <button id="pause" style="width:100%;padding:6px;background:#c00;color:white;font-size:16px;border-radius:5px;">â¸ æš«åœ</button>
        </div>
    `;
    document.body.appendChild(panel);

    // ======== é¸ç¥¨å‡½å¼ ========
    function getPlusButtons() {
        let plus = Array.from(document.querySelectorAll(".plus"));
        if (plus.length) return plus.filter(el => el.offsetParent !== null);
        const candidates = Array.from(document.querySelectorAll("button, a, input[type=button]"))
            .filter(b => (b.innerText || b.value || "").trim() === "+" || /å¢åŠ |åŠ å…¥|åŠ ä¸€/.test((b.innerText || b.value || b.getAttribute('aria-label') || "").trim()));
        return candidates.filter(el => el.offsetParent !== null);
    }

    function selectTicket() {
        const plus = getPlusButtons();
        if (!plus.length) return false;

        const p1 = ($("p1").value || "").trim();
        const p2 = ($("p2").value || "").trim();
        const num = parseInt($("num").value) || 1;
        const mode = $("mode").value;

        if (p1) {
            for (const btn of plus) {
                const row = btn.closest('.display-table-row') || btn.closest('tr') || btn.closest('.ticket-row') || btn.closest('.row');
                if (row && (row.innerText || "").includes(p1)) {
                    for (let i = 0; i < num; i++) btn.click();
                    return true;
                }
            }
        }

        if (p2) {
            for (const btn of plus) {
                const row = btn.closest('.display-table-row') || btn.closest('tr') || btn.closest('.ticket-row') || btn.closest('.row');
                if (row && (row.innerText || "").includes(p2)) {
                    for (let i = 0; i < num; i++) btn.click();
                    return true;
                }
            }
        }

        let btn = plus[0];
        if (mode === "bottom") btn = plus[plus.length - 1];
        if (mode === "random") btn = plus[Math.floor(Math.random() * plus.length)];
        for (let i = 0; i < num; i++) btn.click();
        return true;
    }

    // ======== è‡ªå‹•å¡«å•é¡Œèˆ‡æœƒå“¡ã€å‹¾é¸åŒæ„ ========
    function autoFillQuestionAndMember() {
        try {
            const ANSWER = ($("answer") && $("answer").value) ? $("answer").value.trim() : "";
            const qSelectors = [
                'input[placeholder*="å›ç­”"]',
                'input[placeholder*="è«‹è¼¸å…¥"]',
                'input[placeholder*="å•é¡Œ"]',
                'input[ng-model*="custom"]',
                'input[ng-model*="question"]',
                'input[type="text"].custom-question',
                'input[type="text"][name*="question"]'
            ];
            let qField = null;
            for (const s of qSelectors) {
                qField = document.querySelector(s);
                if (qField) break;
            }
            if (!qField) {
                const containers = Array.from(document.querySelectorAll(".custom-captcha, .custom-captcha-inner, .ticket-captcha, .captcha"));
                for (const c of containers) {
                    const cand = c.querySelector('input[type="text"]');
                    if (cand) {
                        qField = cand;
                        break;
                    }
                }
            }

            if (qField && ANSWER) {
                qField.focus();
                qField.value = ANSWER;
                qField.dispatchEvent(new Event("input",{bubbles:true}));
                qField.dispatchEvent(new Event("change",{bubbles:true}));
                toast("âœï¸ å·²è‡ªå‹•å¡«å…¥å•é¡Œç­”æ¡ˆ");
            }

            const mem = ($("member").value || "").trim();
            if (mem) {
                const memField = document.querySelector('input.member-code, input[ng-model*="member_codes"], input[placeholder*="æœƒå“¡"], input[name*="member"], input[id*="member"]');
                if (memField) {
                    memField.focus();
                    memField.value = mem;
                    memField.dispatchEvent(new Event("input",{bubbles:true}));
                    toast("ğŸ§¾ å·²å¡«å…¥æœƒå“¡ç·¨è™Ÿ");
                }
            }

            const agree = document.querySelector('input[type="checkbox"]');
            if (agree && !agree.checked) {
                try { agree.click(); } catch(e) { agree.checked = true; agree.dispatchEvent(new Event("change",{bubbles:true})); }
            }
        } catch(e) { console.warn("autoFillQuestionAndMember error:", e); }
    }

    // ======== è‡ªå‹•ä¸‹ä¸€æ­¥ / é…ä½ ========
    function clickNextOrAutoSeat() {
        try {
            autoFillQuestionAndMember();
            const auto = [...document.querySelectorAll('button, a, input[type=button], input[type=submit]')]
                .find(b => /é…ä½|è‡ªå‹•é…ä½|è‡ªå‹•åˆ†é…|Auto seat|Auto assign|Auto/.test((b.innerText||b.value||b.getAttribute('aria-label')||"").trim()));
            if(auto){ auto.click(); return; }

            const next = [...document.querySelectorAll('button, input[type=button], input[type=submit]')]
                .find(b => /(ä¸‹ä¸€æ­¥|Next|Proceed|å‰å¾€)/.test((b.innerText||b.value||b.getAttribute('aria-label')||"").trim()));
            if(next){ next.click(); return; }

            const fallback = document.querySelector('.next, .btn-next, #nextStep');
            if(fallback) fallback.click();
        } catch(e) { console.warn("clickNextOrAutoSeat error:", e); }
    }

    // ======== ä¸»æµç¨‹ï¼ˆå«æœ€å¤§é‡è©¦ï¼‰ ========
    function main() {
        if(!running) return;

        const maxRetryInput = parseInt(($("maxRetry") && $("maxRetry").value) || "10");
        const maxRetry = isNaN(maxRetryInput) || maxRetryInput<1 ? 10 : maxRetryInput;

        try {
            if(selectTicket()) {
                try { alarm.play(); } catch(e){}
                setTimeout(clickNextOrAutoSeat,200);
                retryCount=0;
            } else {
                retryCount++;
                if(retryCount>maxRetry){
                    running=false;
                    toast(`âš  å·²é”æœ€å¤§é‡è©¦æ¬¡æ•¸ (${maxRetry})ï¼Œåœæ­¢é‡æ•´`);
                    console.warn("Reached max retry count, stopping script");
                } else {
                    setTimeout(()=>running && location.reload(),1000);
                }
            }
        } catch(e){
            console.error("main error:", e);
            retryCount++;
            if(retryCount>maxRetry){
                running=false;
                toast(`âš  ç™¼ç”ŸéŒ¯èª¤ä¸”å·²é”æœ€å¤§é‡è©¦æ¬¡æ•¸ (${maxRetry})ï¼Œåœæ­¢`);
            } else {
                setTimeout(()=>running && location.reload(),1000);
            }
        }
    }

    // ======== æ§åˆ¶æŒ‰éˆ• ========
    $("start").onclick = ()=>{
        const T = ($("startTime").value||"").trim();
        retryCount=0;
        if(!T){
            running=true;
            toast("ğŸš€ ç«‹å³æ¶ç¥¨å•Ÿå‹•");
            main();
        } else {
            toast("â³ è¨­å®šæ’ç¨‹å•Ÿå‹•æˆåŠŸ");
            const timer = setInterval(()=>{
                if(!running && new Date().toTimeString().slice(0,8) >= T){
                    clearInterval(timer);
                    running=true;
                    retryCount=0;
                    toast("ğŸ”¥ é–‹å§‹æ¶ç¥¨ï¼");
                    main();
                }
            },200);
        }
    };

    $("pause").onclick = ()=>{
        running=false;
        toast("â¸ æš«åœæ¶ç¥¨");
    };

    // é é¢è¼‰å…¥æ™‚å˜—è©¦å¡«å…¥
    setTimeout(()=>{ try{ autoFillQuestionAndMember(); }catch(e){} },800);

    // DOM ç›£è½ï¼Œè‡ªå‹•è§¸ç™¼ main
    const pageObserver = new MutationObserver(()=>{ if(running) setTimeout(()=>{ if(running) main(); },120); });
    pageObserver.observe(document.body,{childList:true,subtree:true});

})();
