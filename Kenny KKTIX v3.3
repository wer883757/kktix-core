// ==UserScript==
// @name         Kenny KKTIX v3.3ï¼ˆå¯æ‹–æ›³ + è¨˜æ†¶è¨­å®š + æ’ç¨‹æ¶ç¥¨ + è‡ªå‹•é…ä½ + ä¸‹ä¸€æ­¥ + éˆ´è² + è‡ªå‹•æç¤º + ç„¡ç¥¨è‡ªå‹•ç¢ºèª + æ¶åˆ°åœæ­¢ + è‡ªå‹•ç­”é¡Œï¼‰
// @namespace    https://tampermonkey.net/
// @version      3.3
// @description  v3.3: å«è‡ªå‹•ç­”é¡ŒåŠŸèƒ½ï¼ˆQA æ¸…å–®ï¼‰ã€å¯æœ€å°åŒ–ã€è¨˜æ†¶è¨­å®šã€å®šæ™‚å•Ÿå‹•ã€è‡ªå‹•é¸ç¥¨ã€è‡ªå‹•é‡æ•´ã€è‡ªå‹•é…ä½ã€è‡ªå‹•ä¸‹ä¸€æ­¥ã€è‡ªå‹•å¡«æœƒå“¡ã€è‡ªå‹•æ¶ˆå¤±æç¤ºã€ç„¡ç¥¨è‡ªå‹•ç¢ºèªã€æ¶åˆ°ç¥¨å¾Œè‡ªå‹•åœæ­¢ã€éˆ´è²é€šçŸ¥
// @match        https://kktix.com/events/*/registrations/new*
// @run-at       document-idle
// @grant        none
// ==/UserScript==

(function () {
    'use strict';

    // ====== åŸºæœ¬è®Šæ•¸ ======
    let running = false;
    let autoStop = false;
    const alarm = new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg");
    const $ = id => document.getElementById(id);
    const LS_PREFIX = "kenny_";

    // ====== é€šç”¨å‡½å¼ ======
    function toast(msg) {
        const div = document.createElement("div");
        div.innerText = msg;
        div.style.cssText = `
            position: fixed; top: 15%; right: 20px; z-index: 99999;
            background: rgba(0,0,0,0.85); color: #fff; padding: 10px 16px;
            border-radius: 8px; font-size: 16px; box-shadow: 0 0 8px #000;
            transition: opacity .4s;
        `;
        document.body.appendChild(div);
        setTimeout(() => (div.style.opacity = "0"), 900);
        setTimeout(() => div.remove(), 1300);
    }

    // ====== ç„¡ç¥¨è‡ªå‹•ç¢ºèª ======
    function autoHandleSoldOut() {
        const soldOutTexts = ["å·²ç„¡ç¥¨", "æ²’æœ‰ç¥¨", "å”®å®Œ"];
        const observer = new MutationObserver(mutations => {
            mutations.forEach(m => {
                m.addedNodes.forEach(node => {
                    if (node.nodeType !== 1) return;
                    const text = node.innerText || "";
                    if (soldOutTexts.some(t => text.includes(t))) {
                        const btn = [...node.querySelectorAll("button, input[type=button]")]
                            .find(b => /ç¢ºå®š|OK|ç¢ºèª/.test(b.innerText || b.value || ""));
                        if (btn) try { btn.click(); } catch(e){}
                        toast("âš  ç„¡ç¥¨è¨Šæ¯è‡ªå‹•ç¢ºèª");
                    }
                });
            });
        });
        observer.observe(document.body, { childList: true, subtree: true });
    }
    autoHandleSoldOut();

    // ====== å»º GUI ======
    const panel = document.createElement("div");
    panel.innerHTML = `
        <div id="kenny-box" style="background:#111;color:#eee;padding:12px;position:fixed;top:20%;right:20px;z-index:9999;width:300px;
             font-size:14px;border-radius:10px;border:1px solid #666;">
            <h3 id="kenny-title" style="margin-top:0;text-align:center;font-size:18px;cursor:move;">ğŸ« Kenny KKTIX v3.3</h3>

            <div id="kenny-content">
                <label>ä¸»ç¥¨åƒ¹</label>
                <input id="p1" type="text" placeholder="ä¾‹ï¼šTWD$2,200" style="width:100%;margin-bottom:6px">

                <label>å‚™æ´ç¥¨åƒ¹ï¼ˆç©º=ä»»æ„ï¼‰</label>
                <input id="p2" type="text" placeholder="ä¾‹ï¼šTWD$1,800" style="width:100%;margin-bottom:6px">

                <label>å¼µæ•¸</label>
                <select id="num" style="width:100%;margin-bottom:6px">
                    <option>1</option><option selected>2</option><option>3</option><option>4</option><option>5</option>
                </select>

                <label>æ¨¡å¼</label>
                <select id="mode" style="width:100%;margin-bottom:6px">
                    <option value="top">ç”±ä¸Šè€Œä¸‹</option>
                    <option value="bottom">ç”±ä¸‹è€Œä¸Š</option>
                    <option value="random" selected>éš¨æ©Ÿ</option>
                </select>

                <label>æœƒå“¡ç·¨è™Ÿï¼ˆå¯ç•™ç©ºï¼‰</label>
                <input id="member" type="text" placeholder="ä¾‹ï¼šBZ583022889" style="width:100%;margin-bottom:6px">

                <label>å•Ÿå‹•æ™‚é–“ (ç©º=ç«‹å³)</label>
                <input id="startTime" type="text" placeholder="HH:MM:SS" style="width:100%;margin-bottom:10px">

                <div style="display:flex;gap:6px;margin-bottom:6px;">
                    <button id="start" style="flex:1;padding:6px;background:#06f;color:white;font-size:15px;border-radius:5px;">â–¶ å•Ÿå‹•</button>
                    <button id="pause" style="flex:1;padding:6px;background:#c00;color:white;font-size:15px;border-radius:5px;">â¸ æš«åœ</button>
                </div>

                <hr style="border-color:#333;margin:8px 0;">

                <label style="display:flex;align-items:center;gap:6px;">
                    <input id="autoAnswerToggle" type="checkbox" /> è‡ªå‹•ç­”é¡Œ
                </label>
                <textarea id="qaList" placeholder="ä¸€è¡Œä¸€ç­†ï¼šå•é¡Œ => ç­”æ¡ˆï¼Œä¾‹å¦‚ï¼šä½å€ => å°åŒ—å¸‚ä¿¡ç¾©å€" style="width:100%;height:80px;margin-top:6px;"></textarea>

                <div style="display:flex;gap:6px;margin-top:8px;">
                    <button id="saveSettings" style="flex:1;padding:6px;background:#2a7;color:white;border-radius:5px;">ğŸ’¾ å­˜è¨­å®š</button>
                    <button id="resetSettings" style="flex:1;padding:6px;background:#666;color:white;border-radius:5px;">ğŸ—‘ æ¸…é™¤</button>
                </div>
            </div>

            <button id="minBtn" style="width:100%;margin-top:6px;padding:6px;background:#444;color:#fff;border-radius:5px;">ğŸ”½ æœ€å°åŒ–</button>
        </div>
    `;
    document.body.appendChild(panel);

    // ====== å–å¾—å…ƒç´ å¿«æ·æ–¹å¼ ======
    function $$(id) { return document.getElementById(id); } // è¦†è“‹ä¸Šæ–¹ç°¡å–® getter

    // ====== è¼‰å…¥/å„²å­˜è¨­å®š ======
    const fields = ["p1","p2","num","mode","member","startTime","qaList","autoAnswerToggle"];
    function loadSettings() {
        fields.forEach(id => {
            const key = LS_PREFIX + id;
            if (localStorage.getItem(key) !== null) {
                const el = $(id);
                if (!el) return;
                if (el.type === "checkbox") el.checked = localStorage.getItem(key) === "1";
                else el.value = localStorage.getItem(key);
            }
        });
    }
    function saveSettings() {
        fields.forEach(id => {
            const el = $(id);
            if (!el) return;
            const key = LS_PREFIX + id;
            if (el.type === "checkbox") localStorage.setItem(key, el.checked ? "1" : "0");
            else localStorage.setItem(key, el.value.trim());
        });
        toast("ğŸ’¾ è¨­å®šå·²å„²å­˜");
    }
    // åˆå§‹è¼‰å…¥
    loadSettings();

    // save / reset æŒ‰éˆ•
    $("saveSettings").addEventListener("click", saveSettings);
    $("resetSettings").addEventListener("click", () => {
        fields.forEach(id => localStorage.removeItem(LS_PREFIX + id));
        // å¦‚æœæƒ³é¦¬ä¸Šæ¸…ç©º UI
        fields.forEach(id => {
            const el = $(id);
            if (!el) return;
            if (el.type === "checkbox") el.checked = false;
            else el.value = "";
        });
        toast("ğŸ—‘ è¨­å®šå·²æ¸…é™¤");
    });

    // ====== æœ€å°åŒ– / å±•é–‹ ======
    $("minBtn").onclick = () => {
        const box = $("kenny-content");
        if (box.style.display === "none") {
            box.style.display = "block";
            $("minBtn").innerText = "ğŸ”½ æœ€å°åŒ–";
        } else {
            box.style.display = "none";
            $("minBtn").innerText = "ğŸ”¼ å±•é–‹";
        }
    };

    // ====== å¯æ‹–æ›³ GUIï¼ˆè¨˜ä½ä½ç½®ï¼‰ ======
    (function draggable() {
        const box = $("kenny-box");
        let x = 0, y = 0, drag = false;
        // è¼‰å…¥ä¸Šæ¬¡ä½ç½®
        const left = localStorage.getItem(LS_PREFIX + "pos_left");
        const top = localStorage.getItem(LS_PREFIX + "pos_top");
        if (left && top) {
            box.style.left = left;
            box.style.top = top;
            box.style.right = "auto";
        }
        box.addEventListener("mousedown", e => {
            // åªåœ¨æ¨™é¡Œæˆ– box è¢«æŒ‰ä¸‹æ™‚æ‹–æ›³ï¼ˆé¿å…é»æ“Š inputï¼‰
            if (e.target.tagName.toLowerCase() === "input" || e.target.tagName.toLowerCase() === "textarea" || e.target.tagName.toLowerCase() === "select" || e.target.tagName.toLowerCase() === "button") return;
            drag = true;
            x = e.clientX - box.offsetLeft;
            y = e.clientY - box.offsetTop;
            box.style.transition = "none";
        });
        document.addEventListener("mousemove", e => {
            if (!drag) return;
            box.style.left = `${e.clientX - x}px`;
            box.style.top = `${e.clientY - y}px`;
            box.style.right = "auto";
        });
        document.addEventListener("mouseup", () => {
            if (drag) {
                drag = false;
                // å­˜ä½ç½®
                localStorage.setItem(LS_PREFIX + "pos_left", box.style.left);
                localStorage.setItem(LS_PREFIX + "pos_top", box.style.top);
            }
        });
    })();

    // ====== é¸ç¥¨ ======
    function selectTicket() {
        const plus = document.querySelectorAll(".plus");
        if (!plus.length) return false;

        const p1 = $("p1").value.trim();
        const p2 = $("p2").value.trim();
        const num = parseInt($("num").value) || 1;
        const mode = $("mode").value;

        // ä¸»ç¥¨
        for (const btn of plus) {
            try {
                if (p1 && btn.closest('.display-table-row')?.innerText.includes(p1)) {
                    for (let i = 0; i < num; i++) btn.click();
                    return true;
                }
            } catch(e){}
        }

        // å‚™æ´ç¥¨
        if (p2) {
            for (const btn of plus) {
                try {
                    if (btn.closest('.display-table-row')?.innerText.includes(p2)) {
                        for (let i = 0; i < num; i++) btn.click();
                        return true;
                    }
                } catch(e){}
            }
        }

        // ä»»æ„ç¥¨
        if (!p2) {
            const arr = Array.from(plus);
            let btn = arr[0];
            if (mode === "bottom") btn = arr[arr.length - 1];
            if (mode === "random") btn = arr[Math.floor(Math.random() * arr.length)];
            for (let i = 0; i < num; i++) btn.click();
            return true;
        }
        return false;
    }

    // ====== è‡ªå‹•ä¸‹ä¸€æ­¥ / é…ä½ ======
    function clickNextOrAutoSeat() {
        try {
            document.querySelector('input[type="checkbox"]')?.click();
        } catch(e){}
        const mem = $("member").value.trim();
        const memField = document.querySelector('input.member-code, input[ng-model*="member_codes"], input[placeholder*="æœƒå“¡"]');
        if (mem && memField) {
            memField.focus();
            memField.value = mem;
            memField.dispatchEvent(new Event("input", { bubbles: true }));
        }

        const auto = [...document.querySelectorAll('button')].find(b => b.innerText.includes("é…ä½"));
        if (auto) try { auto.click(); return; } catch(e){}
        const next = [...document.querySelectorAll('button,input')]
            .find(b => (b.innerText || b.value || "").includes("ä¸‹ä¸€æ­¥"));
        if (next) try { next.click(); } catch(e){}
    }

    // ====== åµæ¸¬æ˜¯å¦æˆåŠŸé€²å…¥çµå¸³ï¼ˆè‡ªå‹•åœæ­¢é‡æ•´ï¼‰ ======
    const stopPatterns = ["è¨‚å–®è³‡è¨Š", "ä»˜æ¬¾æ–¹å¼", "ä¿¡ç”¨å¡", "å–ç¥¨", "å¯„é€è³‡è¨Š"];
    setInterval(() => {
        try {
            if (stopPatterns.some(t => document.body.innerText.includes(t))) {
                running = false;
                if (!autoStop) {
                    autoStop = true;
                    alarm.play();
                    toast("ğŸ‰ æ¶åˆ°ç¥¨ï¼å·²åœæ­¢é‡æ•´");
                }
            }
        } catch(e){}
    }, 500);

    // ====== ä¸»æµç¨‹ ======
    function main() {
        if (!running) return;

        // å˜—è©¦è‡ªå‹•ç­”é¡Œï¼ˆè‹¥é–‹å•Ÿï¼‰
        if ($("autoAnswerToggle").checked) {
            try { autoAnswerFromList(); } catch(e){}
        }

        if (selectTicket()) {
            alarm.play();
            setTimeout(clickNextOrAutoSeat, 200);
        } else {
            setTimeout(() => running && location.reload(), 1000);
        }
    }

    // ====== æ§åˆ¶æŒ‰éˆ• ======
    $("start").onclick = () => {
        alarm.play().catch(()=>{}); // å…è¨±éŸ³æ•ˆæ’­æ”¾æ¬Šé™å»ºç«‹

        saveSettings();
        const T = $("startTime").value.trim();
        if (!T) {
            running = true;
            toast("ğŸš€ ç«‹å³æ¶ç¥¨å•Ÿå‹•");
            main();
        } else {
            toast("â³ æ’ç¨‹å•Ÿå‹•å·²è¨­å®š");
            const timer = setInterval(() => {
                if (!running && new Date().toTimeString().slice(0, 8) >= T) {
                    clearInterval(timer);
                    running = true;
                    toast("ğŸ”¥ é–‹å§‹æ¶ç¥¨ï¼");
                    main();
                }
            }, 200);
        }
    };
    $("pause").onclick = () => {
        running = false;
        toast("â¸ æš«åœæ¶ç¥¨");
    };

    // ====== è‡ªå‹•ç­”é¡ŒåŠŸèƒ½ ======
    // QA æ¸…å–®æ ¼å¼ï¼šæ¯è¡Œä¸€ç­† "å•é¡Œ => ç­”æ¡ˆ"
    function parseQAList() {
        const raw = $("qaList").value || "";
        const lines = raw.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
        const pairs = [];
        lines.forEach(line => {
            const sep = line.includes("=>") ? "=>" : line.includes("â†’") ? "â†’" : line.includes(":") ? ":" : null;
            if (!sep) return;
            const parts = line.split(sep);
            if (parts.length < 2) return;
            const q = parts[0].trim();
            const a = parts.slice(1).join(sep).trim();
            if (q) pairs.push({ q, a });
        });
        return pairs;
    }

    // å˜—è©¦å»æ‰¾åˆ°å•é¡Œå°æ‡‰çš„è¼¸å…¥ä¸¦å¡«å…¥
    function autoAnswerFromList() {
        const pairs = parseQAList();
        if (!pairs.length) return;

        // å¹«åŠ©å‡½å¼ï¼šdispatch event
        function setValue(el, val) {
            if (!el) return;
            try {
                if (el.tagName.toLowerCase() === "select") {
                    // å˜—è©¦é¸æ“‡åŒ…å«æ–‡å­—çš„ option
                    const opts = Array.from(el.options);
                    const o = opts.find(o=> (o.text||"").includes(val) || (o.value||"").includes(val));
                    if (o) el.value = o.value;
                    else el.value = val;
                } else if (el.type === "checkbox" || el.type === "radio") {
                    el.checked = !!val;
                } else {
                    el.focus();
                    el.value = val;
                }
                el.dispatchEvent(new Event("input", { bubbles: true }));
                el.dispatchEvent(new Event("change", { bubbles: true }));
            } catch(e){}
        }

        // æœå°‹ç­–ç•¥ï¼š
        // 1) æ‰¾åˆ° labelï¼ˆinnerText å«å•é¡Œï¼‰ï¼Œè‹¥ label æœ‰ for -> ç”¨ for æŒ‡å‘ input
        // 2) æ‰¾åˆ°åŒ…å«å•é¡Œæ–‡å­—çš„å®¹å™¨ï¼ˆ.question, .field-label, p, td, th, div æ¨£å¼ï¼‰ï¼Œç„¶å¾Œæ‰¾ä¸‹æ–¹/æ—é‚Šçš„ input/textarea/select
        // 3) å˜—è©¦ç”¨ placeholder æˆ– aria-label å«å•é¡Œ
        pairs.forEach(({q,a}) => {
            // 1) label for
            const labels = Array.from(document.querySelectorAll("label")).filter(lb => (lb.innerText||"").includes(q));
            for (const lb of labels) {
                try {
                    const forId = lb.getAttribute("for");
                    if (forId) {
                        const target = document.getElementById(forId);
                        if (target) { setValue(target, a); return; }
                    }
                    // å¦‚æœ label åŒ…å« input å­å…ƒç´ 
                    const innerInput = lb.querySelector("input,textarea,select");
                    if (innerInput) { setValue(innerInput, a); return; }
                    // å¦å‰‡å˜—è©¦æ‰¾ label çš„ä¸‹ä¸€å€‹ input
                    const sibling = lb.nextElementSibling;
                    if (sibling) {
                        const found = sibling.querySelector("input,textarea,select") || (sibling.tagName && /input|textarea|select/i.test(sibling.tagName) ? sibling : null);
                        if (found) { setValue(found, a); return; }
                    }
                } catch(e){}
            }

            // 2) å¸¸è¦‹ question container
            const containers = Array.from(document.querySelectorAll(".question, .field-label, .field, .form-group, .form-row, td, th, p, div"));
            for (const c of containers) {
                try {
                    if ((c.innerText||"").includes(q)) {
                        // æ‰¾ child input
                        const found = c.querySelector("input,textarea,select") ||
                            c.nextElementSibling?.querySelector?.("input,textarea,select") ||
                            c.parentElement?.querySelector?.("input,textarea,select");
                        if (found) { setValue(found, a); return; }
                    }
                } catch(e){}
            }

            // 3) placeholder / aria-label / title
            const placeholderMatches = Array.from(document.querySelectorAll('input[placeholder], textarea[placeholder], input[aria-label], input[title], textarea[aria-label], textarea[title]'))
                .filter(el => ((el.getAttribute("placeholder")||"") + (el.getAttribute("aria-label")||"") + (el.getAttribute("title")||"")).includes(q));
            if (placeholderMatches.length) { setValue(placeholderMatches[0], a); return; }

            // 4) æœ€å¾Œå˜—è©¦æŒ‰åå­—åŒ¹é… input name å±¬æ€§åŒ…å« q çš„ï¼ˆä¸å¸¸ç”¨ï¼‰
            const nameMatches = Array.from(document.querySelectorAll('input[name], textarea[name], select[name]')).filter(el => (el.getAttribute("name")||"").toLowerCase().includes(q.toLowerCase()));
            if (nameMatches.length) { setValue(nameMatches[0], a); return; }
        });
    }

    // ====== ç•¶é é¢å‹•æ…‹å‡ºç¾é¡Œç›®æ™‚è‡ªå‹•å˜—è©¦å¡«ç­”ï¼ˆç”¨ observerï¼‰ ======
    const qaObserver = new MutationObserver(muts => {
        if (!$("autoAnswerToggle").checked) return;
        // å°é »ç‡åŸ·è¡Œå¡«ç­”ä»¥å…å¤ªé »ç¹
        try { autoAnswerFromList(); } catch(e){}
    });
    qaObserver.observe(document.body, { childList: true, subtree: true });

    // ====== ç•«é¢è¼‰å…¥å¾Œè‹¥é–‹å•Ÿ auto answer å…ˆåŸ·è¡Œä¸€æ¬¡ ======
    if ($("autoAnswerToggle").checked) {
        try { autoAnswerFromList(); } catch(e){}
    }

    // ====== é é¢è®Šå‹•æ™‚è‡ªå‹•å•Ÿå‹• mainï¼ˆç”¨çŸ­ intervalï¼‰ ======
    setInterval(() => {
        try {
            if (running) main();
        } catch(e){}
    }, 800);

    // ====== æœ€å¾Œæç¤º ======
    console.log("Kenny KKTIX v3.3 å·²è¼‰å…¥ï¼ˆå«è‡ªå‹•ç­”é¡ŒåŠŸèƒ½ï¼‰ã€‚");
    toast("Kenny v3.3 å·²å°±ç·’");
})();
