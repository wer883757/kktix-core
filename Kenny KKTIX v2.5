// ==UserScript==
// @name         Kenny KKTIX v2.5ï¼ˆå…¨è‡ªå‹•æ¶ç¥¨ + ä¸‰æ¨¡å¼é¸åƒ¹ + éˆ´è²é€šçŸ¥ï¼‰
// @namespace    https://tampermonkey.net/
// @version      2.5
// @description  è‡ªå‹•é¸ç¥¨ã€è‡ªå‹•é‡æ•´ã€è‡ªå‹•é…ä½ã€è‡ªå‹•å¡«è³‡æ–™ã€è‡ªå‹•éˆ´è²æé†’ï¼ˆæ¶ç¥¨å…¨è‡ªå‹•ï¼‰
// @match        https://kktix.com/events/*/registrations/new*
// @run-at       document-idle
// @grant        none
// @license      MIT
// ==/UserScript==

(function () {
    'use strict';

    // ==== ä½¿ç”¨è€…è¨­å®š ====
    const ENABLE_TIMER = true;
    const START_TIME = "22:26:10";            // é–‹å§‹æ¶ç¥¨æ™‚é–“
    const REFRESH_INTERVAL = 1000;            // æ²’ç¥¨æ™‚é‡æ•´ï¼ˆæ¯«ç§’ï¼‰
    const ticket_price_primary = 'TWD$2,200'; // ä¸»ç¥¨åƒ¹
    const ticket_price_backup = '';           // å‚™æ´ç¥¨åƒ¹ï¼ˆç©º = ä»»æ„åƒ¹ä½ï¼‰
    const ticket_num = 2;                     // å¼µæ•¸
    const MEMBER_CODE = 'BZ583022889';        // æœƒå“¡ç·¨è™Ÿ
    const CAPTCHA_MODE = 'manual';            // 'manual' / 'fixed'
    const CAPTCHA_VALUE = '';
    const ticket_select_mode = 'random';      // 'top' / 'bottom' / 'random'
    const DEBUG = true;

    // ==== LOG ====
    const log = (...a) => DEBUG && console.log('[KKTIX]', ...a);

    // ==== éˆ´è² ====
    const alarm = new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg");


    // ==== è‡ªå‹•å¡«å€¼å·¥å…· ====
    function safeVal(el, value) {
        if (!el) return false;
        el.focus();
        el.value = value;
        el.dispatchEvent(new Event('input', { bubbles: true }));
        el.dispatchEvent(new Event('change', { bubbles: true }));
        el.blur();
        return true;
    }

    // ==== é¸ç¥¨ ====
    function trySelectTickets() {
        const plusButtons = document.querySelectorAll(".plus");
        if (!plusButtons.length) return false;

        // ä¸»ç¥¨åƒ¹
        for (const btn of plusButtons) {
            const row = btn.closest('.display-table-row');
            if (row?.innerText.includes(ticket_price_primary)) {
                for (let i = 0; i < ticket_num; i++) btn.click();
                log(`é¸åˆ°ä¸»ç¥¨åƒ¹ï¼š${ticket_price_primary}`);
                return true;
            }
        }

        // å‚™æ´ç¥¨åƒ¹
        if (ticket_price_backup) {
            for (const btn of plusButtons) {
                const row = btn.closest('.display-table-row');
                if (row?.innerText.includes(ticket_price_backup)) {
                    for (let i = 0; i < ticket_num; i++) btn.click();
                    log(`ä¸»ç„¡ç¥¨ â†’ æ”¹é¸å‚™æ´ç¥¨åƒ¹ï¼š${ticket_price_backup}`);
                    return true;
                }
            }
        }

        // ä»»æ„ç¥¨åƒ¹ï¼ˆä¾ç­–ç•¥ï¼‰
        if (ticket_price_backup === "") {
            const arr = Array.from(plusButtons);
            let btn = null;

            if (ticket_select_mode === 'top') {
                btn = arr[0]; log("ä»»æ„åƒ¹ä½ â†’ ç”±ä¸Šè€Œä¸‹");
            } else if (ticket_select_mode === 'bottom') {
                btn = arr[arr.length - 1]; log("ä»»æ„åƒ¹ä½ â†’ ç”±ä¸‹è€Œä¸Š");
            } else if (ticket_select_mode === 'random') {
                const idx = Math.floor(Math.random() * arr.length);
                btn = arr[idx];
                log(`ä»»æ„åƒ¹ä½ â†’ éš¨æ©Ÿé¸ï¼ˆç¬¬ ${idx + 1} æ¬¾ï¼‰`);
            } else {
                log("âš ï¸ ticket_select_mode è¨­å®šéŒ¯èª¤ï¼");
                return false;
            }

            for (let i = 0; i < ticket_num; i++) btn.click();
            return true;
        }
        return false;
    }

    // ==== æ¢æ¬¾ + æœƒå“¡ + é©—è­‰ç¢¼ + ä¸‹ä¸€æ­¥ ====
    function handleAgreementAndCaptcha() {
        document.querySelector('input[type="checkbox"]')?.click();
        const mem = document.querySelector('input.member-code, input[ng-model*="member_codes"], input[placeholder*="æœƒå“¡"]');
        if (mem) safeVal(mem, MEMBER_CODE);

        const cap = document.querySelector('input[name="captcha_answer"], input[placeholder*="é©—è­‰"]');
        if (cap) {
            if (CAPTCHA_MODE === 'fixed' && CAPTCHA_VALUE) {
                safeVal(cap, CAPTCHA_VALUE);
                setTimeout(clickNext, 200);
            } else {
                cap.focus();
                cap.addEventListener('input', () => {
                    if (cap.value.trim().length >= 2) setTimeout(clickNext, 120);
                });
            }
        } else {
            setTimeout(clickNext, 200);
        }
    }

    function clickNext() {
        const next = [...document.querySelectorAll('button,input')].find(b => (b.innerText || b.value || '').includes('ä¸‹ä¸€æ­¥'));
        if (next) return next.click(), log("â¡ï¸ ä¸‹ä¸€æ­¥");

        const auto = [...document.querySelectorAll('button')].find(b => b.innerText.includes('é…ä½'));
        if (auto) return auto.click(), log("ğŸ¯ è‡ªå‹•é…ä½");

        log("âš ï¸ æ‰¾ä¸åˆ°ä¸‹ä¸€æ­¥ / é…ä½æŒ‰éˆ•");
    }

    // ==== ä¸»æµç¨‹ ====
    function main() {
        try {
            if (trySelectTickets()) {
                setTimeout(handleAgreementAndCaptcha, 200);
            } else {
                log("âŒ ç„¡ç¥¨ â†’ é‡æ•´ç­‰å¾…â€¦");
                setTimeout(() => location.reload(), REFRESH_INTERVAL);
            }
        } catch {
            setTimeout(() => location.reload(), REFRESH_INTERVAL);
        }
    }

    // ==== å®šæ™‚å•Ÿå‹• ====
    window.addEventListener("load", () => {
        log("è…³æœ¬å•Ÿå‹• âœ”");

        // åµæ¸¬è…³æœ¬æ˜¯å¦æœªæ³¨å…¥
        setTimeout(() => {
            if (!document.body) alert("âš ï¸ è…³æœ¬æœªæˆåŠŸå•Ÿå‹•ï¼Œè«‹é‡æ–°æ•´ç†ï¼ˆæˆ–æª¢æŸ¥æ“´å……åŠŸèƒ½æ¬Šé™ï¼‰");
        }, 1500);

        if (!ENABLE_TIMER) return setTimeout(main, 400);

        log(`â³ ç­‰å¾…é–‹æ¶æ™‚é–“ï¼š${START_TIME}`);
        const timer = setInterval(() => {
            const now = new Date();
            const cur = now.toTimeString().slice(0, 8);
            if (cur >= START_TIME) {
                clearInterval(timer);
                log(`ğŸš€ é–‹æ¶ ${cur}`);
                setTimeout(main, 10);
            }
        }, 200);
    });

})();

