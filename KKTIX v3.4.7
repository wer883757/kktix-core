// ==UserScript==
// @name         Kenny KKTIX v3.4.7ï¼ˆå®Œå…¨åˆä½µç‰ˆï¼šç„¡é™è¼ªè©¢ + è‡ªå‹•çºŒæ¶ + åˆ¤æ–·å¯é»ï¼‹ï¼‰
// @namespace    https://tampermonkey.net/
// @version      3.4.7
// @description  ç„¡ç¥¨è‡ªå‹•åˆ·æ–°ç›´åˆ°å¯é¸ç¥¨åƒ¹ï¼›åªæ¶çœŸæ­£å¯é»çš„ï¼‹ï¼›é‡æ•´å¾Œè‡ªå‹•çºŒæ¶ï¼›é€²å…¥çµå¸³è‡ªå‹•åœæ­¢ï¼›å®Œæ•´ GUIï¼›æ¨¡å¼ top / bottom / randomï¼›å¯æ’ç¨‹ã€‚
// @match        https://kktix.com/events/*/registrations/new*
// @run-at       document-idle
// @grant        none
// ==/UserScript==

(function () {
    "use strict";

    /* ==============================
       åŸºæœ¬è®Šæ•¸
    ============================== */
    let running = false;
    let autoStop = false;
    const POLL_INTERVAL_MS = 250;
    const RELOAD_DELAY_MS = 200;
    const alarm = new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg");
    const $ = id => document.getElementById(id);

    /* ==============================
       Toast
    ============================== */
    function toast(msg) {
        const d = document.createElement("div");
        d.innerText = msg;
        d.style.cssText = `
            position: fixed; top: 14%; right: 20px; z-index: 99999;
            background: rgba(0,0,0,.85); color: #fff; padding: 10px 16px;
            border-radius: 8px; font-size: 16px;
        `;
        document.body.appendChild(d);
        setTimeout(() => (d.style.opacity = "0"), 900);
        setTimeout(() => d.remove(), 1400);
    }

    /* ==============================
       è‡ªå‹•é—œé–‰ã€Œå”®å®Œ/ç„¡ç¥¨ã€æç¤º
    ============================== */
    function autoHandleSoldOut() {
        const keywords = [
            "å·²ç„¡ç¥¨","å·²å”®å®Œ","æ²’æœ‰ç¥¨","å”®å®Œ",
            "ç›®å‰æ²’æœ‰å¯ä»¥è³¼è²·çš„ç¥¨åˆ¸","ç³Ÿç³•ï¼Œæœ‰äººå¿«æ‚¨ä¸€æ­¥"
        ];

        new MutationObserver(muts => {
            muts.forEach(m => m.addedNodes.forEach(n => {
                if (n.nodeType !== 1) return;
                const txt = n.innerText || "";
                if (!keywords.some(k => txt.includes(k))) return;

                const btn = [...n.querySelectorAll("button,input")]
                    .find(b => /ç¢ºå®š|OK|ç¢ºèª/.test(b.innerText || b.value || ""));
                btn?.click();

                toast("âš  è‡ªå‹•é—œé–‰å”®å®Œæç¤º â†’ æ”¹ç”¨ random æ¨¡å¼çºŒæ¶");
                try { $("mode").value = "random"; } catch(e){}

                if (running) setTimeout(main, 100);
            }));
        }).observe(document.body, { childList: true, subtree: true });
    }
    autoHandleSoldOut();

    /* ==============================
       GUI
    ============================== */
    const gui = document.createElement("div");
    gui.innerHTML = `
        <div id="kenny-box" style="background:#111;color:#eee;padding:12px;position:fixed;
            top:20%;right:20px;z-index:9999;width:280px;border-radius:10px;border:1px solid #666;font-size:14px;">
            <h3 style="margin-top:0;text-align:center;font-size:18px;cursor:move;">ğŸ« Kenny KKTIX v3.4.7</h3>
            <div id="kenny-content">

                <label>å¼µæ•¸</label>
                <select id="num" style="width:100%;margin-bottom:6px">
                    <option>1</option><option selected>2</option>
                    <option>3</option><option>4</option><option>5</option>
                </select>

                <label>æ¨¡å¼</label>
                <select id="mode" style="width:100%;margin-bottom:6px">
                    <option value="top">ç”±ä¸Šè€Œä¸‹</option>
                    <option value="bottom">ç”±ä¸‹è€Œä¸Š</option>
                    <option value="random" selected>éš¨æ©Ÿ</option>
                </select>

                <label>æœƒå“¡ç·¨è™Ÿ</label>
                <input id="member" type="text" placeholder="å¯ç•™ç©º" style="width:100%;margin-bottom:6px">

                <label>å•Ÿå‹•æ™‚é–“ï¼ˆç©º=ç«‹å³ï¼‰</label>
                <input id="startTime" type="text" placeholder="HH:MM:SS" style="width:100%;margin-bottom:10px">

                <button id="start" style="width:100%;padding:6px;background:#06f;color:white;font-size:16px;border-radius:6px;margin-bottom:6px;">â–¶ å•Ÿå‹•</button>
                <button id="pause" style="width:100%;padding:6px;background:#c00;color:white;font-size:16px;border-radius:6px;">â¸ æš«åœ</button>
            </div>
            <button id="minBtn" style="width:100%;margin-top:6px;padding:4px;background:#444;color:#fff;border-radius:6px;">ğŸ”½ æœ€å°åŒ–</button>
        </div>
    `;
    document.body.appendChild(gui);

    /* ==============================
       è¨­å®šè¨˜æ†¶
    ============================== */
    ["num", "mode", "member", "startTime"].forEach(id => {
        const v = localStorage.getItem("kenny_" + id);
        if (v && $(id)) $(id).value = v;
    });

    /* ==============================
       GUI æœ€å°åŒ–
    ============================== */
    $("minBtn").onclick = () => {
        const c = $("kenny-content");
        const show = c.style.display === "none";
        c.style.display = show ? "block" : "none";
        $("minBtn").innerText = show ? "ğŸ”½ æœ€å°åŒ–" : "ğŸ”¼ å±•é–‹";
    };

    /* ==============================
       GUI æ‹–æ›³
    ============================== */
    (function drag() {
        const box = $("kenny-box");
        let dx = 0, dy = 0, dragging = false;
        box.addEventListener("mousedown", e => {
            dragging = true;
            dx = e.clientX - box.offsetLeft;
            dy = e.clientY - box.offsetTop;
        });
        document.addEventListener("mousemove", e => {
            if (!dragging) return;
            box.style.left = e.clientX - dx + "px";
            box.style.top = e.clientY - dy + "px";
            box.style.right = "auto";
        });
        document.addEventListener("mouseup", () => dragging = false);
    })();

    /* ==============================
       åµæ¸¬çµå¸³ â†’ åœæ­¢æ¶ç¥¨
    ============================== */
    function detectCheckoutPage() {
        if (!running) return;
        const html = document.body.innerText || "";
        const keys = [
            "è¨‚å–®æ˜ç´°","è¨‚å–®è³‡è¨Š","è¯çµ¡äººè³‡æ–™","ä»˜æ¬¾æ–¹å¼",
            "ä¿¡ç”¨å¡","å¯„é€è³‡è¨Š","ç¥¨åˆ¸è³‡è¨Š","Step 3","Step 4"
        ];
        if (keys.some(k => html.includes(k))) {
            running = false;
            localStorage.removeItem("kenny_running");
            if (!autoStop) {
                autoStop = true;
                alarm.play();
                toast("ğŸ‰ å·²é€²å…¥çµå¸³é  â€” è‡ªå‹•åœæ­¢æ¶ç¥¨");
            }
        }
    }
    setInterval(detectCheckoutPage, 300);

    /* ==============================
       åˆ¤æ–·æŒ‰éˆ•æ˜¯å¦å¯é»
    ============================== */
    function isButtonClickable(btn) {
        if (!btn) return false;
        if (btn.disabled || btn.classList.contains("disabled")) return false;
        if (btn.offsetParent === null) return false;
        try {
            const cs = window.getComputedStyle(btn);
            if (cs.pointerEvents === "none") return false;
            if (parseFloat(cs.opacity) < 0.2) return false;
        } catch (e) {}
        return true;
    }

    /* ==============================
       ä¸»æ¶ç¥¨å¼•æ“ï¼ˆç„¡é™è¼ªè©¢ï¼‰
    ============================== */
    function main() {
        if (!running) return;

        const rows = document.querySelectorAll(".display-table-row");

        /* ç„¡ç¥¨é¢ â†’ reload */
        if (rows.length === 0) {
            return setTimeout(() => {
                if (running) location.reload();
            }, RELOAD_DELAY_MS);
        }

        /* éæ¿¾çœŸæ­£å¯é»çš„ï¼‹ */
        let plus = [...document.querySelectorAll(".plus")].filter(btn => {
            if (!isButtonClickable(btn)) return false;
            const txt = btn.closest(".display-table-row")?.innerText || "";
            if (/èº«|éšœ|æ®˜|é™ªåŒ/.test(txt)) return false;
            return true;
        });

        /* æœ‰ç¥¨é¢ä½†ç„¡å¯é» â†’ reload */
        if (plus.length === 0) {
            return setTimeout(() => {
                if (running) location.reload();
            }, RELOAD_DELAY_MS);
        }

        /* æ¨¡å¼é¸æ“‡ */
        let targetBtn;
        const mode = $("mode")?.value || "random";

        if (mode === "top") targetBtn = plus[0];
        else if (mode === "bottom") targetBtn = plus[plus.length - 1];
        else targetBtn = plus[Math.floor(Math.random() * plus.length)];

        /* click + */
        try { targetBtn.click(); } catch (e) {}

        /* é¸å¼µæ•¸ */
        setTimeout(() => {
            const count = parseInt($("num")?.value) || 1;
            const addBtn = document.querySelector(".qty-input .plus");
            for (let i = 1; i < count; i++) try { addBtn?.click(); } catch(e){}
        }, 70);

        /* ä¸‹ä¸€æ­¥ */
        setTimeout(() => {
            try { document.querySelector('input[type="checkbox"]')?.click(); } catch(e){}

            const m = $("member")?.value?.trim();
            const mf = document.querySelector('input.member-code,input[placeholder*="æœƒå“¡"]');
            if (mf && m) mf.value = m;

            const nextBtn = [...document.querySelectorAll("button,input")]
                .find(b => (b.innerText || b.value || "").includes("ä¸‹ä¸€æ­¥"));
            try { nextBtn?.click(); } catch(e){}
        }, 140);

        /* ç„¡é™è¼ªè©¢ä¸‹ä¸€è¼ª */
        setTimeout(() => {
            if (running) main();
        }, POLL_INTERVAL_MS);
    }

    /* ==============================
       é‡æ–°æ•´ç†å¾Œè‡ªå‹•çºŒæ¶
    ============================== */
    if (localStorage.getItem("kenny_running") === "1") {
        running = true;
        toast("ğŸ”„ é‡æ–°æ•´ç† â†’ è‡ªå‹•çºŒæ¶ä¸­");
        setTimeout(main, 200);
    }

    /* ==============================
       START / PAUSE
    ============================== */
    $("start").onclick = () => {
        ["num", "mode", "member", "startTime"].forEach(id => {
            localStorage.setItem("kenny_" + id, ($(id)?.value || "").trim());
        });

        const T = $("startTime")?.value?.trim();
        if (!T) {
            running = true;
            localStorage.setItem("kenny_running", "1");
            toast("ğŸš€ æ¶ç¥¨å•Ÿå‹•ï¼");
            return main();
        }

        toast("â³ å·²è¨­å®šæ’ç¨‹â€¦");

        const timer = setInterval(() => {
            if (new Date().toTimeString().slice(0, 8) >= T) {
                clearInterval(timer);
                running = true;
                localStorage.setItem("kenny_running", "1");
                toast("ğŸ”¥ æ™‚é–“åˆ° â†’ è‡ªå‹•é–‹å§‹æ¶ç¥¨");
                main();
            }
        }, 200);
    };

    $("pause").onclick = () => {
        running = false;
        localStorage.removeItem("kenny_running");
        toast("â¸ å·²æš«åœ");
    };

})();
