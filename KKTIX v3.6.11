// ==UserScript==
// @nameÂ  Â  Â  Â  Â Kenny KKTIX v3.6.11
// @namespaceÂ  Â  https://tampermonkey.net/
// @versionÂ  Â  Â  3.6.11
// @descriptionÂ  v3.6.11ï¼šæ–°å¢åŠŸèƒ½ï¼šè‡ªå‹•æ’é™¤æ„›å¿ƒç¥¨/èº«éšœå¸­ç­‰ç‰¹æ®Šç¥¨ç¨®ã€‚
// @matchÂ  Â  Â  Â  https://kktix.com/events/*/registrations/new*
// @run-atÂ  Â  Â  Â document-idle
// @grantÂ  Â  Â  Â  none
// ==/UserScript==

(function () {
Â  Â  'use strict';

Â  Â  let isWaitingForKktixResponse = false;
Â  Â  const STORAGE_KEY = 'kktix_autostart_state';
Â  Â  let running = (localStorage.getItem(STORAGE_KEY) === 'true');
Â  Â  let loopId = null;
Â  Â  const LOOP_INTERVAL = 400;
Â  Â  const RELOAD_COOLDOWN = 900;
Â  Â  let lastReload = 0;
Â  Â  let debug = false;

    // [æ–°å¢] æ’é™¤é—œéµå­—åˆ—è¡¨
    const EXCLUDE_KEYWORDS = ['æ„›å¿ƒ', 'èº«éšœ', 'è¼ªæ¤…', 'å„ªå¾…'];

Â  Â  const alarm = new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg");
Â  Â  const $ = id => document.getElementById(id);

Â  Â  // ======== è‡ªå‹•æ¶ˆå¤±æç¤º / Log ä¿æŒä¸è®Š ========
Â  Â  function toast(msg) {
Â  Â  Â  Â  const div = document.createElement("div");
Â  Â  Â  Â  div.innerText = msg;
Â  Â  Â  Â  div.style.cssText = `
Â  Â  Â  Â  Â  Â  position: fixed; top: 15%; right: 20px; z-index: 99999;
Â  Â  Â  Â  Â  Â  background: rgba(0,0,0,0.85); color: #fff; padding: 10px 16px;
Â  Â  Â  Â  Â  Â  border-radius: 8px; font-size: 16px; box-shadow: 0 0 8px #000;
Â  Â  Â  Â  `;
Â  Â  Â  Â  document.body.appendChild(div);
Â  Â  Â  Â  setTimeout(() => (div.style.opacity = "0"), 900);
Â  Â  Â  Â  setTimeout(() => div.remove(), 1300);
Â  Â  }

Â  Â  function log(...args) {
Â  Â  Â  Â  if (debug) console.log("[KKTIX v3.6.11]", ...args);
Â  Â  }

    // ======== GUI å»ºç«‹ (ç¶­æŒç¾æœ‰å·¦å°é½Šæ¨£å¼) ========
Â  Â  const panel = document.createElement("div");
Â  Â  panel.innerHTML = `
Â  Â  Â  Â  <div id="kenny-panel" style="background:#111;color:#eee;padding:12px;position:fixed;top:20%;right:20px;z-index:9999;width:260px;
Â  Â  Â  Â  Â  Â  Â font-size:14px;border-radius:10px;border:1px solid #666; text-align:left;">
Â  Â  Â  Â  Â  Â  <h3 id="kenny-header" style="margin-top:0;text-align:center;font-size:18px;">ğŸ« Kenny KKTIX</h3>

Â  Â  Â  Â  Â  Â  <label>ä¸»ç¥¨åƒ¹</label>
Â  Â  Â  Â  Â  Â  <input id="p1" type="text" placeholder="ä¾‹ï¼šTWD$2,200" style="width:100%;margin-bottom:6px">

Â  Â  Â  Â  Â  Â  <label>å‚™æ´ç¥¨åƒ¹ï¼ˆç©º=ä»»æ„ï¼‰</label>
Â  Â  Â  Â  Â  Â  <input id="p2" type="text" placeholder="ä¾‹ï¼šTWD$1,800" style="width:100%;margin-bottom:6px">

Â  Â  Â  Â  Â  Â  <label>å¼µæ•¸</label>
Â  Â  Â  Â  Â  Â  <select id="num" style="width:100%;margin-bottom:6px">
Â  Â  Â  Â  Â  Â  Â  Â  <option>1</option><option selected>2</option><option>3</option><option>4</option><option>5</option>
Â  Â  Â  Â  Â  Â  </select>

Â  Â  Â  Â  Â  Â  <label>æ¨¡å¼</label>
Â  Â  Â  Â  Â  Â  <select id="mode" style="width:100%;margin-bottom:6px">
Â  Â  Â  Â  Â  Â  Â  Â  <option value="top">ç”±ä¸Šè€Œä¸‹</option>
Â  Â  Â  Â  Â  Â  Â  Â  <option value="bottom">ç”±ä¸‹è€Œä¸Š</option>
Â  Â  Â  Â  Â  Â  Â  Â  <option value="random" selected>éš¨æ©Ÿ</option>
Â  Â  Â  Â  Â  Â  </select>

Â  Â  Â  Â  Â  Â  <label>æœƒå“¡ç·¨è™Ÿï¼ˆå¯ç•™ç©ºï¼‰</label>
Â  Â  Â  Â  Â  Â  <input id="member" type="text" placeholder="ä¾‹ï¼šBZ583022889" style="width:100%;margin-bottom:6px">

Â  Â  Â  Â  Â  Â  <label>å•Ÿå‹•æ™‚é–“ (ç©º=ç«‹å³)</label>
Â  Â  Â  Â  Â  Â  <input id="startTime" type="text" placeholder="HH:MM:SS" style="width:100%;margin-bottom:10px">

Â  Â  Â  Â  Â  Â  <button id="start" style="width:100%;padding:6px;margin-bottom:6px;background:#06f;color:white;font-size:16px;border-radius:5px;">â–¶ å•Ÿå‹•</button>
Â  Â  Â  Â  Â  Â  <button id="pause" style="width:100%;padding:6px;background:#c00;color:white;font-size:16px;border-radius:5px;">â¸ æš«åœ</button>
Â  Â  Â  Â  </div>
Â  Â  `;
Â  Â  document.body.appendChild(panel);

Â  Â  // header double-click toggle debug
Â  Â  document.getElementById("kenny-header").addEventListener("dblclick", () => {
Â  Â  Â  Â  debug = !debug;
Â  Â  Â  Â  toast(`Debug ${debug ? "ON" : "OFF"}`);
Â  Â  Â  Â  console.log("[KKTIX v3.6.11] debug:", debug);
Â  Â  });

    // ======== æ ¸å¿ƒåŠŸèƒ½å‡½æ•¸å®šç¾© ========

    function cleanPrice(priceString) {
        if (!priceString) return '';
        // ç§»é™¤æ‰€æœ‰éæ•¸å­—å­—ç¬¦ (åŒ…æ‹¬ TWD, $, NT, é€—è™Ÿ, ç©ºæ ¼ç­‰)ï¼Œåªç•™ä¸‹ç´”æ•¸å­—
        return priceString.replace(/[^0-9]/g, '').trim();
    }

    function detectNotYetOpen() {
        const bodyText = document.body.innerText || "";
        const lower = bodyText.toLowerCase();
        const keywords = ["å°šæœªé–‹è³£", "å°šæœªé–‹å§‹", "è²©å”®æ™‚é–“", "ç­‰å¾…é–‹è³£", "å³å°‡é–‹è³£", "å€’æ•¸", "å°šåœ¨æº–å‚™ä¸­", "å°šæœªè²©å”®", "æœªé–‹è³£", "å°šæœªé–‹æ”¾"];
        for (const k of keywords) {
            if (bodyText.includes(k) || lower.includes(k)) { log("detectNotYetOpen matched:", k); return true; }
        }
        if (/(starts in|countdown|coming soon)/i.test(bodyText)) { log("detectNotYetOpen matched english countdown"); return true; }
        return false;
    }

    function selectTicket() {
        const plusAll = Array.from(document.querySelectorAll(".plus"));
        const plus = plusAll.filter(b => {
            if (!b.offsetParent) return false;
            if (b.disabled) return false;
            if (b.getAttribute("aria-disabled") === "true") return false;
            return true;
        });

        if (!plus.length) { log("selectTicket: no available plus buttons"); return false; }

        const p1Raw = ($("p1")?.value || "").trim();
        const p2Raw = ($("p2")?.value || "").trim();
        const p1Clean = cleanPrice(p1Raw);
        const p2Clean = cleanPrice(p2Raw);
        const num = parseInt(($("num")?.value) || "1", 10) || 1;
        const mode = ($("mode")?.value) || "random";

        let foundBtn = null;

        // ç¯©é¸æ‰æ‰€æœ‰åŒ…å«æ’é™¤é—œéµå­—çš„æŒ‰éˆ•
        const availablePlus = plus.filter(btn => {
            const rowText = (btn.closest('.display-table-row')?.innerText || '').toLowerCase();
            // æª¢æŸ¥ç¥¨åƒ¹è¡Œæ–‡å­—æ˜¯å¦åŒ…å«ä»»ä½•æ’é™¤é—œéµå­—
            const isExcluded = EXCLUDE_KEYWORDS.some(keyword => rowText.includes(keyword.toLowerCase()));
            if (isExcluded) {
                log(`Skipping excluded ticket row: ${rowText.trim().substring(0, 30)}...`);
            }
            return !isExcluded;
        });

        if (!availablePlus.length) {
            log("selectTicket: No standard available plus buttons found after exclusion.");
            return false;
        }

        // --- ä¸»ç¥¨é‚è¼¯ ---
        if (p1Clean) {
            for (const btn of availablePlus) {
                const rowText = btn.closest('.display-table-row')?.innerText || '';
                if (cleanPrice(rowText).includes(p1Clean)) {
                    foundBtn = btn;
                    log(`selectTicket: found primary price, clicking: ${p1Clean}`);
                    break;
                }
            }
        }

        // --- å‚™æ´ç¥¨é‚è¼¯ ---
        if (!foundBtn && p2Clean) {
            for (const btn of availablePlus) {
                const rowText = btn.closest('.display-table-row')?.innerText || '';
                if (cleanPrice(rowText).includes(p2Clean)) {
                    foundBtn = btn;
                    log(`selectTicket: found backup price, clicking: ${p2Clean}`);
                    break;
                }
            }
        }

        // --- ä»»æ„ç¥¨é‚è¼¯ ---
        if (!foundBtn && !p2Clean) {
            const arr = availablePlus;
            if (arr.length > 0) {
                if (mode === "bottom") foundBtn = arr[arr.length - 1];
                else if (mode === "random") foundBtn = arr[Math.floor(Math.random() * arr.length)];
                else foundBtn = arr[0];
                log("selectTicket: selecting any ticket via mode", mode);
            }
        }

        if (foundBtn) {
            for (let i = 0; i < num; i++) foundBtn.click();
            return true;
        }

        log("selectTicket: no matching standard price found");
        return false;
    }

    function forceReload(reason) {
        running = false;
        stopLoop();
        log(`forceReload: ${reason}, forcing reload...`);
        setTimeout(() => { location.reload(); }, 100);
    }

    function clickNextOrAutoSeat() {
        try {
            document.querySelector('input[type="checkbox"]')?.click();
            const mem = ($("member")?.value || "").trim();
            const memField = document.querySelector('input.member-code, input[ng-model*="member_codes"], input[placeholder*="æœƒå“¡"], input[placeholder*="Member"]');
            if (mem && memField) {
                memField.focus();
                memField.value = mem;
                memField.dispatchEvent(new Event("input", { bubbles: true }));
                log("member code filled:", mem);
            }
            const auto = [...document.querySelectorAll('button')].find(b => /é…ä½|è‡ªå‹•é…ä½|auto seat/i.test(b.innerText));
            if (auto) {
                log("clicking auto seat button");
                auto.click();
                isWaitingForKktixResponse = true;
                log("clickNextOrAutoSeat: Auto Seat Clicked, waiting for server response.");
                return;
            }
            const next = [...document.querySelectorAll('button,input')].find(b => (b.innerText || b.value || "").includes("ä¸‹ä¸€æ­¥"));
            if (next) {
                log("clicking next button");
                next.click();
                isWaitingForKktixResponse = true;
                log("clickNextOrAutoSeat: Next Button Clicked, waiting for server response.");
            }
        } catch (e) {
            console.error("[KKTIX v3.6.11] clickNextOrAutoSeat error:", e);
        }
    }

    function shouldReload(plusCount) {
        if (detectNotYetOpen()) return true;
        const bodyText = (document.body.innerText || "").toLowerCase();
        if (plusCount === 0 && /(sold out|å·²å”®å®Œ|ç„¡ç¥¨|ç„¡æ³•è³¼è²·|æ²’æœ‰ç¥¨)/i.test(bodyText)) { return true; }
        if (plusCount === 0) { return true; }
        const p1 = ($("p1")?.value || "").trim();
        const p2 = ($("p2")?.value || "").trim();
        const isPreSale = detectNotYetOpen();
        const isStuckOnSoldOutPage = !isPreSale && plusCount > 0 && p1 && p2;
        if (isStuckOnSoldOutPage) { return true; }
        return false;
    }

    function main() {
        if (!running || isWaitingForKktixResponse) return;
        try {
            const plusAll = Array.from(document.querySelectorAll(".plus"));
            const plusVisible = plusAll.filter(b => b.offsetParent && !b.disabled && b.getAttribute("aria-disabled") !== "true");

            // 1. å˜—è©¦é¸ç¥¨
            if (selectTicket()) {
                log("main: selectTicket returned true -> play alarm & next step");
                try { alarm.play(); } catch (e) { log("alarm play failed:", e); }
                setTimeout(clickNextOrAutoSeat, 200);
                return;
            }

            // 2. æ±ºå®šæ˜¯å¦é‡æ•´
            const shouldReloadNow = shouldReload(plusVisible.length);
            const now = Date.now();

            if (shouldReloadNow) {
                if (now - lastReload > RELOAD_COOLDOWN) {
                    lastReload = now;
                    log("main: reloading page (cooldown passed or page needs refresh)");
                    setTimeout(() => { if (running) location.reload(); }, 600 + Math.floor(Math.random() * 300));
                } else {
                    log("main: reload skipped due to cooldown");
                }
            } else {
                log("main: no reload needed, waiting next loop");
            }
        } catch (e) {
            console.error("[KKTIX v3.6.11] main error:", e);
        }
    }

    function startLoop() {
        if (loopId) return;
        loopId = setInterval(() => {
            if (running) main();
            closeCommonPopups();
        }, LOOP_INTERVAL);
        log("loop started, interval:", LOOP_INTERVAL);
    }

    function stopLoop() {
        if (loopId) {
            clearInterval(loopId);
            loopId = null;
            log("loop stopped");
        }
    }

    function closeCommonPopups() {
        const buttons = Array.from(document.querySelectorAll('button, a'));
        const bodyText = document.body.innerText || "";
        const isTargetError = bodyText.includes("ç›®å‰æ²’æœ‰å¯ä»¥è³¼è²·çš„ç¥¨åˆ¸ã€‚");
        const confirmButton = buttons.find(el => /ç¢ºèª|OK|Confirm|Got it/gi.test(el.innerText || "") && el.offsetParent);

        if (confirmButton && isWaitingForKktixResponse) {
            if (isTargetError) {
                confirmButton.click();
                isWaitingForKktixResponse = false;
                log("closeCommonPopups: Target 'No Ticket' error confirmed. Resuming main loop.");
                return;
            }

            confirmButton.click();
            log("closeCommonPopups: General error or browser modal found. Forcing reload.");
            forceReload("Error/Modal encountered after Next click");
            return;
        }

        const reloadConfirm = buttons.find(el => {
            const t = (el.innerText || "").trim();
            return /é‡æ–°è¼‰å…¥|Reload|ç¹¼çºŒ|Continue/gi.test(t) && el.offsetParent;
        });

        if (reloadConfirm && !isWaitingForKktixResponse) {
            reloadConfirm.click();
            log("closeCommonPopups clicked: browser/system reload confirm button (Non-waiting state).");
            return;
        }

        const closeBtns = buttons.filter(el => {
            const t = (el.innerText || "").trim();
            return /é—œé–‰|Close|é–‰|å–æ¶ˆ/gi.test(t);
        });

        closeBtns.forEach(b => {
            try {
                if (b.offsetParent) {
                    b.click();
                    log("closeCommonPopups clicked: generic close button", b.innerText);
                }
            } catch (e) { /* ignore */ }
        });
    }

    // [é é¢è¼‰å…¥æ™‚æª¢æŸ¥æ˜¯å¦éœ€è¦è‡ªå‹•é‡å•Ÿ]
    if (running) {
        toast("ğŸ”„ æª¢æ¸¬åˆ°é‹è¡Œç‹€æ…‹ï¼Œè‡ªå‹•é‡å•Ÿæ¶ç¥¨è¿´åœˆ");
        startLoop();
        setTimeout(main, 80);
    }

    // å•Ÿå‹•èˆ‡æš«åœé‚è¼¯
    $("start").onclick = () => {
        const T = ($("startTime")?.value || "").trim();
        if (!T) {
            running = true;
            localStorage.setItem(STORAGE_KEY, 'true');
            toast("ğŸš€ ç«‹å³æ¶ç¥¨å•Ÿå‹•");
            startLoop();
            setTimeout(main, 80);
        } else {
            toast("â³ è¨­å®šæ’ç¨‹å•Ÿå‹•æˆåŠŸ");
            const timer = setInterval(() => {
                if (!running && new Date().toTimeString().slice(0, 8) >= T) {
                    clearInterval(timer);
                    running = true;
                    localStorage.setItem(STORAGE_KEY, 'true');
                    toast("ğŸ”¥ é–‹å§‹æ¶ç¥¨ï¼");
                    startLoop();
                    setTimeout(main, 80);
                }
            }, 200);
        }
    };

    $("pause").onclick = () => {
        running = false;
        localStorage.removeItem(STORAGE_KEY);
        toast("â¸ æš«åœæ¶ç¥¨");
        stopLoop();
    };

})();
